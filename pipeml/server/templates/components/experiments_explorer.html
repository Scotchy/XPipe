{% extends "components/component.html" %}

{% block component %}

{% include "components/dropdown_parameters.html" %}

<table id="experiments" class="table table-sm" style="margin-top: 10px">
    <thead>
        <tr>
            <th scope="col">#</th>
            <th scope="col">Name</th>
        </tr>
    </thead>
    <tbody id="experiments_list">

    </tbody>
</table>
{% endblock component %}

{% block script %}
<script type="text/javascript">

    function get_exp_header_html(params={}, metrics={}) {
        var html = `
            <th scope="col">#</th>
            <th scope="col">Name</th>
        `;
        for (var i in params) {
            html += `<th scope="col">${params[i]}</th>`;
        }
        for (var i in metrics) {
            html += `<th scope="col">${metrics[i]}</th>`;
        }
        return html;
    }

    function get_exp_item_html(exp, params, metrics, i)  {
        var html = `
        <tr>
            <th>${i}</th>
            <th><a href="/experiment/${exp.id}">${exp.name}</a></th>`; 

        for (var i in params) {
            let param_value = exp.params[params[i]];
            let text = (param_value == null) ? "-" : param_value;
            html += `<th>${text}</th>`;
        }
        html += `</tr>`;
        return html;
    }
    async function update_experiments(folder, params={}, metrics={}) {
        if ($.isEmptyObject(params) && $.isEmptyObject(metrics)) {
            params = JSON.parse(getCookie("params"));
            metrics = JSON.parse(getCookie("metrics")); 
        }
        else {
            setCookie("params", JSON.stringify(params));
            setCookie("metrics", JSON.stringify(metrics));
        }

        var resp = await call_api(
            "/api/run/list", 
            {
                folder: folder, 
                params: params,
                metrics: metrics
            }
        ); 
        var resp = await resp.json();
        var experiments = resp.experiments;
        
        // Set header
        $("#experiments").find("tr").html(
            get_exp_header_html(params, metrics)
        ); 

        // Set items
        var html = ""; 
        for (var i = 0; i < experiments.length; i++) {
            html += get_exp_item_html(experiments[i], params, metrics, i); 
        }
        $("#experiments_list").html(html);
    }

    window.addEventListener("update_folders", e => update_experiments(e.folder));
    window.addEventListener("param.add", e => update_experiments(current_folder(), e.selected_params));
    window.addEventListener("param.remove", e => update_experiments(current_folder(), e.selected_params));
    window.addEventListener("update_metrics", e => update_experiments(e.folder));
    
</script>
{% endblock script %}